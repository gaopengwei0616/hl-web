package com.yida.controller.content;

import com.github.pagehelper.PageHelper;
import com.github.pagehelper.PageInfo;
import com.yida.entity.Category;
import com.yida.entity.News;
import com.yida.entity.Site;
import com.yida.service.AdministerService;
import com.yida.service.CategoryService;
import com.yida.service.LanmuguanliService;
import com.yida.service.SiteService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.Authentication;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.servlet.ModelAndView;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * Created by yeke on 2019/7/8.
 * 管理内容Controller
 */
@Controller
public class LanmuguanliController {

    @Autowired
    private LanmuguanliService lanmuguanliService;
    @Autowired
    private SiteService siteService;
    @Autowired
    private AdministerService administerService;
    @Autowired
    private CategoryService categoryService;

    //管理内容页面跳转
    @RequestMapping("/showLists")
    public ModelAndView lanmuguanli(Authentication authentication,
                                    @RequestParam(defaultValue = "-1",name = "siteid")Integer siteid,
                                    @RequestParam(defaultValue = "0", name = "catid") Integer catid,
                                    @RequestParam(defaultValue = "10", name = "pageSize", required = false) Integer pageSize,
                                    @RequestParam(defaultValue = "0", name = "pageNum", required = false) Integer pageNum) {
        Integer siteByRoleId = lanmuguanliService.getSiteByRoleId(administerService.findAdminByName(authentication.getName()).getRoleid());
        PageHelper.startPage(pageNum, pageSize);
        ModelAndView modelAndView = new ModelAndView();
        Map<String, Object> map = lanmuguanliService.showLanmuguanliMessage(catid);
        PageInfo<News> newsList = (PageInfo<News>) map.get("newsList");
        modelAndView.addObject("page", newsList);
        modelAndView.addObject("pageList", newsList.getList());
        modelAndView.setViewName("/Content/lanmuguanli");
        modelAndView.addObject("value", 1);
        modelAndView.addObject("catid", catid);
        if(siteid!=-1){
            modelAndView.addObject("siteid",siteid);
        }else{
            modelAndView.addObject("siteid",siteByRoleId);
        }
        return modelAndView;
    }

    //跳转数据内容添加修改页面
    @GetMapping("/add_edit_newsData")
    public ModelAndView editNewsData(@RequestParam(name = "news_id",required = false) Integer id,
                                     @RequestParam(name = "catid") Integer catid,
                                     @RequestParam(name = "type") String type) {
        ModelAndView modelAndView = new ModelAndView();
        Map<String, Object> map = new HashMap<>();
        if(type.equals("edit")){
            map = lanmuguanliService.editContentSearch(id, catid);
            modelAndView.addObject("newsData", map.get("newsData"));
            modelAndView.addObject("news", map.get("news"));
        }
        if(type.equals("add")){
            map = lanmuguanliService.addContentSearch(catid);
            modelAndView.addObject("catid", catid);
        }
        modelAndView.setViewName("/ueditor/add_edit_newsData");
        modelAndView.addObject("category", map.get("category"));
        modelAndView.addObject("type", type);
        return modelAndView;
    }


    //修改数据
    @PostMapping("/edit_news_data")
    public ModelAndView editNewsData(@RequestParam(name = "newsid") Integer newsid,
                                @RequestParam(name = "newsDataId") Integer newsDataId,
                                @RequestParam(name = "title") String title,
                                @RequestParam(name = "content") String content,
                                @RequestParam(name = "keywords")String keywords,
                                @RequestParam(name = "url")String url,
                                @RequestParam(name = "status")Integer status,
                                @RequestParam(name = "description")String description
    ) {
        lanmuguanliService.updateNewsAndNewsData(newsid,newsDataId, title, content,keywords,url,status,description);
        ModelAndView modelAndView = new ModelAndView();
        modelAndView.setViewName("redirect:/showLists");
        return modelAndView;
    }

    //添加数据
    @PostMapping("/add_news_data")
    public ModelAndView addNewsData(@RequestParam(name = "catid") Integer catid,
                               @RequestParam(name = "title") String title,
                               @RequestParam(name = "content",defaultValue = "",required = false) String content,
                               @RequestParam(name = "url", required = false) String url,
                               @RequestParam(name = "description", required = false) String description,
                               @RequestParam(name = "typeid", required = false) Integer typeid,
                               @RequestParam(name = "keywords",defaultValue = "",required=false)String keywords,//关键字
                               @RequestParam(name = "inputtime",required = false)String inputtime,//添加时间
                               @RequestParam(name = "status")Integer status//状态
    ) {
        lanmuguanliService.insertNewsAndNewsData(catid, title, url, description, typeid, content,keywords,inputtime,status);
        ModelAndView modelAndView = new ModelAndView();
        modelAndView.setViewName("redirect:/showLists");
        return modelAndView;
    }

    //删除数据
    @GetMapping("/del_news_data")
    @ResponseBody
    public Integer delNewsData(@RequestParam("id") Integer id){
        return lanmuguanliService.deleteNewsAndNewsData(id);
    }


    //获取导航栏数据内容列表
    @GetMapping("/catParentDirList")
    @ResponseBody
    public List<Category> catParentDirList(@RequestParam(name = "siteid",defaultValue = "1")Integer siteid) {
        Map<String, Object> map = lanmuguanliService.catParentDirList(siteid);
        List<Category> categories = (List<Category>)map.get("categories");
        return categories;
    }

    //检查标题是否重复
    @GetMapping("/checkNewsTitle")
    @ResponseBody
    public Integer checkNewsTitle(@RequestParam(name = "title") String title,
                                 @RequestParam(name = "type")String type,
                                 @RequestParam(name = "newsId",required = false)Integer newsId){
        if(title.equals("")){
            return 0;
        }
        return lanmuguanliService.checkNewsTitle(title,type,newsId);
    }

    //显示站点
    @PostMapping("/showSites")
    @ResponseBody
    public List<Site> showSites(Authentication authentication){
        Integer siteByRoleId = lanmuguanliService.getSiteByRoleId(administerService.findAdminByName(authentication.getName()).getRoleid());
        if(siteByRoleId!=1){
            List<Site> list = new ArrayList<>();
            list.add(siteService.SiteBysiteId(siteByRoleId));
            return list;
        }
        return siteService.GetSiteList();
    }

    //跳转到管理栏目页面
    @RequestMapping("/siteSelect")
    public String siteSelect(){
        return "/Content/ManageProgram/siteSelect";
    }

    //跳转到站点栏目页面
    @RequestMapping("/goManager")
    public ModelAndView goManager(@RequestParam("siteid")Integer siteid){
        ModelAndView modelAndView = new ModelAndView();
        modelAndView.setViewName("/Content/ManageProgram/goManager");
        modelAndView.addObject("siteid",siteid);
        return modelAndView;
    }

    //获取指定站点的栏目
    @PostMapping("/getCateList")
    @ResponseBody
    public List<Category> getCateList(@RequestParam("siteid")Integer siteid){
        return categoryService.getCateList(siteid);
    }

    @RequestMapping("/addEditCategory")
    public ModelAndView  addCatrgory(@RequestParam(required = false,name = "siteid")Integer siteid,
                                     @RequestParam(required = false,name = "catid")Integer catid,
                                     @RequestParam("type")String type){
        ModelAndView modelAndView = new ModelAndView();
        modelAndView.setViewName("/Content/ManageProgram/add_edit_Catrgory");
        modelAndView.addObject("siteid",siteid);
        modelAndView.addObject("type",type);
        Site site = siteService.SiteBysiteId(siteid);
        modelAndView.addObject("site",site);
        if(type.equals("edit")){
            Category categoryById = categoryService.getCategoryById(catid);
            modelAndView.addObject("categoryById",categoryById);
        }
        return modelAndView;
    }

    @PostMapping("/addCategory")
    public ModelAndView addCategory(@RequestParam("siteid") Integer siteid,
                                    @RequestParam("catname")String catname,
                                    @RequestParam("catparid") Integer catparid,
                                    @RequestParam("cat_code")String cat_code,
                                    @RequestParam("description")String description){
        Category category = new Category();
        category.setParentid(catparid);
        category.setCat_code(cat_code);
        category.setDescription(description);
        category.setSiteid(siteid);
        category.setName(catname);
        category.setStatus(1);

        category.setImage(" ");
        category.setUrl("");
        category.setIsmenu(0);
        categoryService.insertSelectiveCategory(category);
        ModelAndView modelAndView = new ModelAndView();
        modelAndView.setViewName("redirect:/goManager?siteid="+siteid);
        return modelAndView;
    }

    @PostMapping("/editCategory")
    public ModelAndView editCategory(@RequestParam("siteid") Integer siteid,
                                     @RequestParam("catname")String catname,
                                     @RequestParam("catid") Integer catid,
                                     @RequestParam("catparid")Integer catparid,
                                     @RequestParam("cat_code")String cat_code,
                                     @RequestParam("description")String description){
        Category category = categoryService.getCategoryById(catid);
        category.setName(catname);
        category.setCat_code(cat_code);
        category.setDescription(description);
        if(catparid==null){
            category.setParentid(0);
        }else{
            category.setParentid(catparid);
        }
        categoryService.updateByPrimaryKeySelective(category);
        ModelAndView modelAndView = new ModelAndView();
        modelAndView.setViewName("redirect:/goManager?siteid="+siteid);
        return modelAndView;
    }

    @GetMapping("/deleteCategory")
    @ResponseBody
    public Integer deleteCategory(@RequestParam("catid")Integer catid){
        return categoryService.deleteCategory(catid);
    }
}